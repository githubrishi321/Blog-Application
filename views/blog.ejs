<!DOCTYPE html>
<html lang="en">
  <head>
    <%- include('./partials/head') %>
    <title><%= blog.title %> - Blogify</title>
  </head>
  <body>
    <%- include('./partials/nav') %>

    <div class="container">
      <div class="main-content">
        <!-- Blog Header -->
        <div class="row mb-4">
          <div class="col-12">
            <h1 class="blog-title"><%= blog.title %></h1>
          </div>
        </div>

        <!-- Blog Cover Image -->
        <% if (blog.coverImageURL) { %>
          <div class="row mb-4">
            <div class="col-12">
              <div class="position-relative">
                <img src="<%= blog.coverImageURL %>" class="img-fluid rounded" style="max-height: 400px; width: 100%; object-fit: cover;" 
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                <div class="bg-light p-5 text-center rounded" style="display: none; min-height: 300px;">
                  <i class="fas fa-image fa-3x text-muted"></i>
                  <p class="text-muted mt-3">Cover image not available</p>
                </div>
              </div>
            </div>
          </div>
        <% } %>

        <!-- Blog Content -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="blog-content">
              <pre style="white-space: pre-wrap; font-family: inherit; background: transparent; border: none; padding: 0;"><%= blog.body %></pre>
            </div>
          </div>
        </div>

        <!-- Author Info -->
        <div class="row mb-4">
          <div class="col-12">
            <div class="author-info">
              <% if (blog.createdBy) { %>
                <img src="<%= blog.createdBy.profileImageURL %>" class="author-avatar"
                     onerror="this.src='/Images/default.svg';" />
                <div>
                  <h6 class="mb-1 fw-bold"><%= blog.createdBy.fullName %></h6>
                  <small class="text-muted">
                    <i class="fas fa-calendar me-1"></i>
                    <%= new Date(blog.createdAt).toLocaleDateString() %>
                  </small>
                </div>
              <% } else { %>
                <img src="/Images/default.svg" class="author-avatar" />
                <div>
                  <h6 class="mb-1 fw-bold">Unknown Author</h6>
                  <small class="text-muted">Author information not available</small>
                </div>
              <% } %>
            </div>
          </div>
        </div>

        <!-- Comments Section -->
        <div class="comment-section">
          <div class="row mb-4">
            <div class="col-12">
              <h3 class="blog-title">
                <i class="fas fa-comments me-3"></i>Comments (<%= comments.length %>)
              </h3>
            </div>
          </div>

          <!-- Add Comment Form -->
          <% if (locals.user) { %>
            <div class="row mb-4">
              <div class="col-12">
                <div class="card">
                  <div class="card-body">
                    <h5 class="card-title">
                      <i class="fas fa-plus me-2"></i>Add a Comment
                    </h5>
                    <form action="/blog/comment/<%= blog._id %>" method="post">
                      <div class="mb-3">
                        <textarea
                          name="content"
                          class="form-control"
                          placeholder="Share your thoughts..."
                          rows="3"
                          required
                        ></textarea>
                      </div>
                      <button class="btn btn-primary" type="submit">
                        <i class="fas fa-paper-plane me-2"></i>Post Comment
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          <% } else { %>
            <div class="row mb-4">
              <div class="col-12">
                <div class="alert alert-info">
                  <i class="fas fa-info-circle me-2"></i>
                  Please <a href="/user/signin" class="alert-link">sign in</a> to leave a comment.
                </div>
              </div>
            </div>
          <% } %>

          <!-- Comments List -->
          <div class="row">
            <div class="col-12">
              <% if (comments.length === 0) { %>
                <div class="text-center py-5">
                  <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                  <h5 class="text-muted">No comments yet</h5>
                  <p class="text-muted">Be the first to share your thoughts!</p>
                </div>
              <% } else { %>
                <% comments.forEach(comment => { %>
                  <div class="comment-card">
                    <div class="comment-author">
                      <% if (comment.createdBy) { %>
                        <img src="<%= comment.createdBy.profileImageURL %>" class="comment-avatar"
                             onerror="this.src='/Images/default.svg';" />
                        <div class="flex-grow-1">
                          <h6 class="mb-1 fw-bold"><%= comment.createdBy.fullName %></h6>
                          <small class="comment-date">
                            <i class="fas fa-clock me-1"></i>
                            <%= new Date(comment.createdAt).toLocaleDateString() %>
                          </small>
                        </div>
                      <% } else { %>
                        <img src="/Images/default.svg" class="comment-avatar" />
                        <div class="flex-grow-1">
                          <h6 class="mb-1 fw-bold text-muted">Unknown User</h6>
                          <small class="comment-date">User information not available</small>
                        </div>
                      <% } %>
                    </div>
                    <div class="comment-content">
                      <%= comment.content %>
                    </div>
                  </div>
                <% }) %>
              <% } %>
            </div>
          </div>
        </div>
      </div>
    </div>

    <%- include('./partials/scripts') %>
  </body>
</html>